name: Convert Jupyter Notebooks to Markdown

on:
  push:
    paths:
      - 'notebooks/*.ipynb'
  pull_request:
    paths:
      - 'notebooks/*.ipynb'

jobs:
  convert:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install nbconvert and dependencies
        run: |
          pip install nbconvert jupyter

      - name: Convert Notebooks to Markdown and Add Headings
        run: |
          # Define the final output folder
          final_folder="_posts"

          # Find and convert all Jupyter notebooks to Markdown, processing each notebook one at a time
          for notebook in $(find notebooks -name '*.ipynb'); do
              echo "Processing $notebook"

              # Create a temporary file to store the converted Markdown
              
              # Convert the Jupyter notebook to Markdown and write to the temporary file
              if ! jupyter nbconvert --to markdown "$notebook" --output temp_file.md; then
                  echo "Failed to convert $notebook"
                  continue
              fi

              # Print the content of the temporary file for debugging
              echo "Temporary Markdown file content:"
              cat temp_file.md

              # Extract the first heading from the converted Markdown file
              title=$(grep -m 1 '^# ' temp_file.md | sed 's/^# //')

              # Print the extracted title for debugging
              echo "Extracted title: $title"

              # Add the full markdown heading to the file with the extracted title
              output_file="$final_folder/$(basename "$notebook" .ipynb).md"
              echo -e "---\nlayout: post\ntitle: $title\n---\n\n$(cat temp_file.md)" > "$output_file"

              # Print the content of the final Markdown file for debugging
              echo "Final Markdown file content:"
              cat "$output_file"

              # Remove the temporary file
              rm temp_file.md
          done

      - name: Commit changes
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
      
          # Identify new and modified files
          added_files=$(git ls-files --others --exclude-standard _posts/*.md)
          modified_files=$(git diff --name-only _posts/*.md)
      
          # Initialize variables for commit message and file counts
          commit_message=""
          total_added=0
          total_modified=0
      
          # Function to determine version number for a specific file
          get_file_version() {
              file=$1
              # Count the number of times the file has been edited
              edit_count=$(git log --oneline -- "$file" | wc -l)
              # Increment edit count by 1 to determine the new version number
              echo $((edit_count + 1))
          }
      
          # Process newly added files
          for file in $added_files; do
              if [ -n "$file" ]; then
                  total_added=$((total_added + 1))
                  version=$(get_file_version "$file")
                  commit_message+="New file: $file (Version $version) at $(date +"%Y-%m-%d %H:%M:%S")\n"
              fi
          done
      
          # Process modified files
          for file in $modified_files; do
              if [ -n "$file" ]; then
                  total_modified=$((total_modified + 1))
                  version=$(get_file_version "$file")
                  commit_message+="Modified file: $file (Version $version) at $(date +"%Y-%m-%d %H:%M:%S")\n"
              fi
          done
      
          # Check if there were files to commit
          if [ $total_added -gt 0 ] || [ $total_modified -gt 0 ]; then
              # Create a summary line for the commit message
              summary_line="Converted Jupyter Notebooks to Markdown: $total_added new file(s) added, $total_modified file(s) modified."
      
              # Combine the summary line with detailed messages
              full_commit_message="$summary_line\n\nDetails:\n$commit_message"
      
              # Stage new and modified files
              git add $added_files $modified_files
      
              # Commit the changes with the improved message
              git commit -m "$full_commit_message"
              git push
          else
              echo "No new or modified files to commit."
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
